services:
  toolbox:
    # TODO: It is recommended to pin to a specific image version instead of latest.
    image:  us-central1-docker.pkg.dev/database-toolbox/toolbox/toolbox:latest
    hostname: toolbox
    platform: linux/amd64
    ports:
      - "${TOOLBOX_PORT}:5000"
    volumes:
      - ./config:/config
    environment:
      MINDSDB_USER: ${MINDSDB_USER}
      MINDSDB_PASSWORD: ${MINDSDB_PASSWORD}
    command: [ "toolbox", "--tools_file", "/config/tools.yaml", "--address", "0.0.0.0",  "--ui"]
    depends_on:
      db:
        condition: service_healthy
      mindsdb:
        condition: service_healthy
    networks:
      - tool-network
  db:
    # TODO: It is recommended to pin to a specific image version instead of latest.
    image: postgres
    hostname: db
    environment:
      POSTGRES_USER: toolbox_user
      POSTGRES_PASSWORD: my-password
      POSTGRES_DB: toolbox_db
    ports:
      - "${DB_PORT}:5432"
    volumes:
      - ./db:/var/lib/postgresql
      # This file can be used to bootstrap your schema if needed.
      # See "initialization scripts" on https://hub.docker.com/_/postgres/ for more info
      - ./config/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U toolbox_user -d toolbox_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - tool-network
  mindsdb:
    image: mindsdb/mindsdb
    environment:
      - MINDSDB_USERNAME=${MINDSDB_USER}
      - MINDSDB_PASSWORD=${MINDSDB_PASSWORD}
      - MINDSDB_APIS=http,mysql
    ports:
      - "${MINDSDB_API_PORT:-47334}:47334"  # HTTP API & Web GUI
      - "${MINDSDB_MYSQL_PORT:-47335}:47335"  # MySQL API
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:47334/api/status || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    networks:
      - tool-network
networks:
  tool-network:

